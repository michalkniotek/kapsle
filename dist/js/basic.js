'use strict';

var bezier = require('bezier');
var PIXI = require('pixi.js');
var popmotion = require('popmotion');
var distance = require('euclidean-distance');
var seedrandom = require('seedrandom');
require('sugar');

var renderer = new PIXI.CanvasRenderer(window.innerWidth, window.innerHeight, { backgroundColor: 0xF0F8FF });
document.body.appendChild(renderer.view);

var createWorld = function createWorld(hash) {
    var stage = new PIXI.Container();
    var points = [];
    var sorted_points_indexes = [];
    var sortedPoints = [];
    var sorted_points_corrected = [];
    var max_points = 15;
    var borderPixels = 50;
    var Full360 = Math.PI * 2;

    var randomGenerator = seedrandom(hash);

    for (var i = 0; i < max_points; i++) {
        points.push({ 'x': borderPixels + randomGenerator() * (window.innerWidth - 2 * borderPixels), 'y': borderPixels + randomGenerator() * (window.innerHeight - 2 * borderPixels) });
    }

    sorted_points_indexes.push(0);
    while (sorted_points_indexes.length < max_points) {
        var min_distance = 999999999;
        var min_distance_point_index = 0;
        for (var i = 1; i < points.length; i++) {
            if (sorted_points_indexes.findIndex(i) == -1) {
                var dist_temp = distance(Object.values(points[sorted_points_indexes.last()]), Object.values(points[i]));
                if (dist_temp < min_distance) {
                    min_distance = dist_temp;
                    min_distance_point_index = i;
                }
            }
        }
        sorted_points_indexes.push(min_distance_point_index);
    }

    sortedPoints = sorted_points_indexes.map(function (i) {
        return points[i];
    });
    sortedPoints.each(function (value, index) {
        sorted_points_corrected.push(value);
        if (index < sortedPoints.length - 2) {
            var nextValue = sortedPoints[index + 1];
            var random = randomGenerator() * 1.5 + 0.5;
            sorted_points_corrected.push({
                x: (nextValue.x - value.x) * random + nextValue.x,
                y: (nextValue.y - value.y) * random + nextValue.y
            });
        }
    });

    var sorted_points_indexes_without_first = sorted_points_indexes.clone().removeAt(0);

    var xbezier = [];
    var ybezier = [];

    sorted_points_corrected.each(function (point) {
        xbezier.push(point.x);
        ybezier.push(point.y);
    });

    var superPoints = [];
    for (var t = 0; t <= 1; t += 0.01) {
        superPoints.push({
            x: bezier(xbezier, t),
            y: bezier(ybezier, t)
        });
    }

    var kapselTexture = PIXI.Texture.fromImage('img/kapsel.png');

    var kapsel = new PIXI.Sprite(kapselTexture);

    var actorKapsel = new popmotion.Actor({
        onUpdate: function onUpdate(output) {
            console.log(output);
        }
    });

    var tween = new popmotion.Tween({
        values: {
            x: 300,
            y: 300
        }
    });

    actorKapsel.start(tween);

    renderRoad();
    renderPoints();
    renderKapsel();
    animate();

    function animate() {
        requestAnimationFrame(animate);

        kapsel.rotation = kapsel.rotation + 0.1;
        if (kapsel.rotation > Full360) {
            kapsel.rotation = kapsel.rotation - Full360;
        }

        // render the container
        renderer.render(stage);
    }

    function renderPoints() {
        var g = new PIXI.Graphics();
        g.clear();
        g.lineStyle(2, 0xffc2c2);
        g.moveTo(sorted_points_indexes[0].x, sorted_points_indexes[0].y);

        superPoints.each(function (point) {
            g.lineTo(point.x, point.y);
        });

        for (var i = 0; i < superPoints.length; i++) {
            g.beginFill(0xff0022);
            g.drawCircle(superPoints[i].x, superPoints[i].y, 10);
            g.endFill();
        }
        stage.addChild(g);
    }

    function renderRoad() {
        var strip = new PIXI.mesh.Rope(PIXI.Texture.fromImage('img/road.jpg'), superPoints);
        stage.addChild(strip);
    }

    function renderKapsel() {
        kapsel.anchor.x = 0.5;
        kapsel.anchor.y = 0.5;

        kapsel.position.x = superPoints[1].x;
        kapsel.position.y = superPoints[1].y;

        stage.addChild(kapsel);
    }
};
window.addEventListener("hashchange", function () {
    return createWorld(location.hash);
});
createWorld(location.hash);
//# sourceMappingURL=data:application/json;base64,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QUFJLENBQUMsSUFBSSxDQUFDLElBQUksQ0FBQyxPQUFPLENBQUMsU0FBUyxDQUFDLGNBQWMsQ0FBQyxFQUFFLFdBQVcsQ0FBQyxDQUFDO0FBQ3BGLGFBQUssQ0FBQyxRQUFRLENBQUMsS0FBSyxDQUFDLENBQUM7S0FDekI7O0FBRUQsYUFBUyxZQUFZLEdBQUc7QUFDcEIsY0FBTSxDQUFDLE1BQU0sQ0FBQyxDQUFDLEdBQUcsR0FBRyxDQUFDO0FBQ3RCLGNBQU0sQ0FBQyxNQUFNLENBQUMsQ0FBQyxHQUFHLEdBQUcsQ0FBQzs7QUFFdEIsY0FBTSxDQUFDLFFBQVEsQ0FBQyxDQUFDLEdBQUcsV0FBVyxDQUFDLENBQUMsQ0FBQyxDQUFDLENBQUMsQ0FBQTtBQUNwQyxjQUFNLENBQUMsUUFBUSxDQUFDLENBQUMsR0FBRyxXQUFXLENBQUMsQ0FBQyxDQUFDLENBQUMsQ0FBQyxDQUFBOztBQUVwQyxhQUFLLENBQUMsUUFBUSxDQUFDLE1BQU0sQ0FBQyxDQUFDO0tBQzFCO0NBQ0osQ0FBQTtBQUNELE1BQU0sQ0FBQyxnQkFBZ0IsQ0FBQyxZQUFZLEVBQUM7V0FBSSxXQUFXLENBQUMsUUFBUSxDQUFDLElBQUksQ0FBQztDQUFBLENBQUMsQ0FBQTtBQUNwRSxXQUFXLENBQUMsUUFBUSxDQUFDLElBQUksQ0FBQyxDQUFBIiwiZmlsZSI6ImpzL2Jhc2ljLmpzIiwic291cmNlc0NvbnRlbnQiOlsidmFyIGJlemllciA9IHJlcXVpcmUoJ2JlemllcicpXG52YXIgUElYSSA9IHJlcXVpcmUoJ3BpeGkuanMnKVxudmFyIHBvcG1vdGlvbiA9IHJlcXVpcmUoJ3BvcG1vdGlvbicpXG52YXIgZGlzdGFuY2UgPSByZXF1aXJlKCdldWNsaWRlYW4tZGlzdGFuY2UnKVxudmFyIHNlZWRyYW5kb20gPSByZXF1aXJlKCdzZWVkcmFuZG9tJylcbnJlcXVpcmUoJ3N1Z2FyJylcblxudmFyIHJlbmRlcmVyID0gbmV3IFBJWEkuQ2FudmFzUmVuZGVyZXIod2luZG93LmlubmVyV2lkdGgsIHdpbmRvdy5pbm5lckhlaWdodCx7YmFja2dyb3VuZENvbG9yIDogMHhGMEY4RkZ9KTtcbmRvY3VtZW50LmJvZHkuYXBwZW5kQ2hpbGQocmVuZGVyZXIudmlldyk7XG5cbnZhciBjcmVhdGVXb3JsZCA9IChoYXNoKT0+e1xuICAgIHZhciBzdGFnZSA9IG5ldyBQSVhJLkNvbnRhaW5lcigpO1xuICAgIHZhciBwb2ludHMgPSBbXTtcbiAgICB2YXIgc29ydGVkX3BvaW50c19pbmRleGVzID0gW107XG4gICAgdmFyIHNvcnRlZFBvaW50cyA9IFtdO1xuICAgIHZhciBzb3J0ZWRfcG9pbnRzX2NvcnJlY3RlZCA9IFtdO1xuICAgIHZhciBtYXhfcG9pbnRzID0gMTU7XG4gICAgdmFyIGJvcmRlclBpeGVscyA9IDUwO1xuICAgIHZhciBGdWxsMzYwID0gTWF0aC5QSSAqIDI7XG4gICAgXG4gICAgdmFyIHJhbmRvbUdlbmVyYXRvciA9IHNlZWRyYW5kb20oaGFzaCk7XG4gICAgXG4gICAgZm9yICh2YXIgaSA9IDA7IGkgPCBtYXhfcG9pbnRzOyBpKyspXG4gICAge1xuICAgICAgICBwb2ludHMucHVzaCh7J3gnOiBib3JkZXJQaXhlbHMgKyAocmFuZG9tR2VuZXJhdG9yKCkgKiAod2luZG93LmlubmVyV2lkdGggLSAyICogYm9yZGVyUGl4ZWxzKSksICd5JzogYm9yZGVyUGl4ZWxzICsgKHJhbmRvbUdlbmVyYXRvcigpICogKHdpbmRvdy5pbm5lckhlaWdodCAtIDIgKiBib3JkZXJQaXhlbHMpKX0pXG4gICAgfVxuICAgIFxuICAgIHNvcnRlZF9wb2ludHNfaW5kZXhlcy5wdXNoKDApXG4gICAgd2hpbGUgKHNvcnRlZF9wb2ludHNfaW5kZXhlcy5sZW5ndGggPCBtYXhfcG9pbnRzKSB7XG4gICAgICAgIHZhciBtaW5fZGlzdGFuY2UgPSA5OTk5OTk5OTk7XG4gICAgICAgIHZhciBtaW5fZGlzdGFuY2VfcG9pbnRfaW5kZXggPSAwO1xuICAgICAgICBmb3IoIHZhciBpID0xOyBpPCBwb2ludHMubGVuZ3RoOyBpKyspIHtcbiAgICAgICAgICAgIGlmIChzb3J0ZWRfcG9pbnRzX2luZGV4ZXMuZmluZEluZGV4KGkpID09IC0xKSB7XG4gICAgICAgICAgICAgICAgdmFyIGRpc3RfdGVtcCA9IGRpc3RhbmNlKE9iamVjdC52YWx1ZXMocG9pbnRzW3NvcnRlZF9wb2ludHNfaW5kZXhlcy5sYXN0KCldKSwgT2JqZWN0LnZhbHVlcyhwb2ludHNbaV0pKVxuICAgICAgICAgICAgICAgIGlmIChkaXN0X3RlbXAgPCBtaW5fZGlzdGFuY2UpIHtcbiAgICAgICAgICAgICAgICAgICAgbWluX2Rpc3RhbmNlID0gZGlzdF90ZW1wXG4gICAgICAgICAgICAgICAgICAgIG1pbl9kaXN0YW5jZV9wb2ludF9pbmRleCA9IGlcbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICB9XG4gICAgICAgIH1cbiAgICAgICAgc29ydGVkX3BvaW50c19pbmRleGVzLnB1c2gobWluX2Rpc3RhbmNlX3BvaW50X2luZGV4KVxuICAgIH1cbiAgICBcbiAgICBcbiAgICBcbiAgICBzb3J0ZWRQb2ludHMgPSBzb3J0ZWRfcG9pbnRzX2luZGV4ZXMubWFwKChpKT0+cG9pbnRzW2ldKTtcbiAgICBzb3J0ZWRQb2ludHMuZWFjaChcbiAgICAgICAgKHZhbHVlLGluZGV4KT0+e1xuICAgICAgICAgICAgc29ydGVkX3BvaW50c19jb3JyZWN0ZWQucHVzaCh2YWx1ZSk7XG4gICAgICAgICAgICBpZihpbmRleDxzb3J0ZWRQb2ludHMubGVuZ3RoLTIpIHtcbiAgICAgICAgICAgICAgICBsZXQgbmV4dFZhbHVlID0gc29ydGVkUG9pbnRzW2luZGV4ICsgMV1cbiAgICAgICAgICAgICAgICBsZXQgcmFuZG9tID0gcmFuZG9tR2VuZXJhdG9yKCkgKiAxLjUgKyAwLjU7XG4gICAgICAgICAgICAgICAgc29ydGVkX3BvaW50c19jb3JyZWN0ZWQucHVzaCh7XG4gICAgICAgICAgICAgICAgICAgIHg6ICgobmV4dFZhbHVlLnggLSB2YWx1ZS54KSAqIHJhbmRvbSkgKyBuZXh0VmFsdWUueCxcbiAgICAgICAgICAgICAgICAgICAgeTogKChuZXh0VmFsdWUueSAtIHZhbHVlLnkpICogcmFuZG9tKSArIG5leHRWYWx1ZS55XG4gICAgICAgICAgICAgICAgfSk7XG4gICAgICAgICAgICB9XG4gICAgfSlcbiAgICBcbiAgICB2YXIgc29ydGVkX3BvaW50c19pbmRleGVzX3dpdGhvdXRfZmlyc3QgPSBzb3J0ZWRfcG9pbnRzX2luZGV4ZXMuY2xvbmUoKS5yZW1vdmVBdCgwKVxuICAgIFxuICAgIHZhciB4YmV6aWVyID0gW107XG4gICAgdmFyIHliZXppZXIgPSBbXTtcbiAgICBcbiAgICBzb3J0ZWRfcG9pbnRzX2NvcnJlY3RlZC5lYWNoKGZ1bmN0aW9uKHBvaW50KSB7XG4gICAgICAgIHhiZXppZXIucHVzaChwb2ludC54KVxuICAgICAgICB5YmV6aWVyLnB1c2gocG9pbnQueSlcbiAgICB9KVxuICAgIFxuICAgIHZhciBzdXBlclBvaW50cyA9IFtdO1xuICAgIGZvciAodmFyIHQgPSAwOyB0IDw9IDE7IHQgKz0gMC4wMSkge1xuICAgICAgICBzdXBlclBvaW50cy5wdXNoKHtcbiAgICAgICAgICAgIHg6IGJlemllcih4YmV6aWVyLCB0KSxcbiAgICAgICAgICAgIHk6IGJlemllcih5YmV6aWVyLCB0KVxuICAgICAgICB9KTtcbiAgICB9XG4gICAgXG4gICAgdmFyIGthcHNlbFRleHR1cmUgPSBQSVhJLlRleHR1cmUuZnJvbUltYWdlKCdpbWcva2Fwc2VsLnBuZycpO1xuICAgIFxuICAgIHZhciBrYXBzZWwgPSBuZXcgUElYSS5TcHJpdGUoa2Fwc2VsVGV4dHVyZSk7XG4gICAgXG4gICAgXG4gICAgdmFyIGFjdG9yS2Fwc2VsID0gbmV3IHBvcG1vdGlvbi5BY3Rvcih7XG4gICAgICAgIG9uVXBkYXRlOiBmdW5jdGlvbiAob3V0cHV0KSB7XG4gICAgICAgICAgICBjb25zb2xlLmxvZyhvdXRwdXQpO1xuICAgICAgICB9XG4gICAgfSk7XG4gICAgXG4gICAgdmFyIHR3ZWVuID0gbmV3IHBvcG1vdGlvbi5Ud2Vlbih7XG4gICAgICAgIHZhbHVlczoge1xuICAgICAgICAgICAgeDogMzAwLFxuICAgICAgICAgICAgeTogMzAwXG4gICAgICAgIH1cbiAgICB9KTtcbiAgICBcbiAgICBhY3RvckthcHNlbC5zdGFydCh0d2VlbilcbiAgICBcbiAgICByZW5kZXJSb2FkKCk7XG4gICAgcmVuZGVyUG9pbnRzKCk7XG4gICAgcmVuZGVyS2Fwc2VsKCk7XG4gICAgYW5pbWF0ZSgpO1xuICAgIFxuICAgIGZ1bmN0aW9uIGFuaW1hdGUoKSB7XG4gICAgICAgIHJlcXVlc3RBbmltYXRpb25GcmFtZShhbmltYXRlKTtcbiAgICBcbiAgICAgICAga2Fwc2VsLnJvdGF0aW9uID0gKGthcHNlbC5yb3RhdGlvbiArIDAuMSlcbiAgICAgICAgaWYoa2Fwc2VsLnJvdGF0aW9uPiBGdWxsMzYwKXtcbiAgICAgICAgICAgIGthcHNlbC5yb3RhdGlvbiA9IGthcHNlbC5yb3RhdGlvbi1GdWxsMzYwO1xuICAgICAgICB9XG4gICAgXG4gICAgICAgIC8vIHJlbmRlciB0aGUgY29udGFpbmVyXG4gICAgICAgIHJlbmRlcmVyLnJlbmRlcihzdGFnZSk7XG4gICAgfVxuICAgIFxuICAgIGZ1bmN0aW9uIHJlbmRlclBvaW50cygpIHtcbiAgICAgICAgdmFyIGcgPSBuZXcgUElYSS5HcmFwaGljcygpO1xuICAgICAgICBnLmNsZWFyKCk7XG4gICAgICAgIGcubGluZVN0eWxlKDIsMHhmZmMyYzIpO1xuICAgICAgICBnLm1vdmVUbyhzb3J0ZWRfcG9pbnRzX2luZGV4ZXNbMF0ueCxzb3J0ZWRfcG9pbnRzX2luZGV4ZXNbMF0ueSk7XG4gICAgXG4gICAgICAgIHN1cGVyUG9pbnRzLmVhY2goKHBvaW50KT0+e1xuICAgICAgICAgICAgZy5saW5lVG8ocG9pbnQueCxwb2ludC55KVxuICAgICAgICB9KVxuICAgIFxuICAgICAgICBmb3IgKHZhciBpID0gMDsgaSA8IHN1cGVyUG9pbnRzLmxlbmd0aDsgaSsrKSB7XG4gICAgICAgICAgICBnLmJlZ2luRmlsbCgweGZmMDAyMik7XG4gICAgICAgICAgICBnLmRyYXdDaXJjbGUoc3VwZXJQb2ludHNbaV0ueCxzdXBlclBvaW50c1tpXS55LDEwKTtcbiAgICAgICAgICAgIGcuZW5kRmlsbCgpO1xuICAgICAgICB9XG4gICAgICAgIHN0YWdlLmFkZENoaWxkKGcpXG4gICAgfVxuICAgIFxuICAgIFxuICAgIGZ1bmN0aW9uIHJlbmRlclJvYWQoKSB7XG4gICAgICAgIHZhciBzdHJpcCA9IG5ldyBQSVhJLm1lc2guUm9wZShQSVhJLlRleHR1cmUuZnJvbUltYWdlKCdpbWcvcm9hZC5qcGcnKSwgc3VwZXJQb2ludHMpO1xuICAgICAgICBzdGFnZS5hZGRDaGlsZChzdHJpcCk7XG4gICAgfVxuICAgIFxuICAgIGZ1bmN0aW9uIHJlbmRlckthcHNlbCgpIHtcbiAgICAgICAga2Fwc2VsLmFuY2hvci54ID0gMC41O1xuICAgICAgICBrYXBzZWwuYW5jaG9yLnkgPSAwLjU7XG4gICAgXG4gICAgICAgIGthcHNlbC5wb3NpdGlvbi54ID0gc3VwZXJQb2ludHNbMV0ueFxuICAgICAgICBrYXBzZWwucG9zaXRpb24ueSA9IHN1cGVyUG9pbnRzWzFdLnlcbiAgICBcbiAgICAgICAgc3RhZ2UuYWRkQ2hpbGQoa2Fwc2VsKTtcbiAgICB9XG59XG53aW5kb3cuYWRkRXZlbnRMaXN0ZW5lcihcImhhc2hjaGFuZ2VcIiwoKT0+Y3JlYXRlV29ybGQobG9jYXRpb24uaGFzaCkpXG5jcmVhdGVXb3JsZChsb2NhdGlvbi5oYXNoKVxuXG4iXSwic291cmNlUm9vdCI6Ii9zb3VyY2UvIn0=
